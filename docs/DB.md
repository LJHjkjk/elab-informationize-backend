# 数据库设计

## 一、用户

储存在中mysql

其中部分已经在casdoor的表中有了。

### casdoor中的表

以下是casdoor中包含的且目前有用的字段：

+ owner：所属组织，都是elab，这个是user的主键。。。。
+ name：用户名字，这个也是主键不能重复，有点离谱。。。
+ id：唯一id，这个居然不是主键。。。
+ avatar：头像链接
+ password：密码
+ displayName：在用户界面显示的名字
+ email
+ phone
+ Roles：用户群组的数组
+ Permissions：用户权限的数组

还有一些账户信息，例如qq，微信等。

### 额外的表

因为casdoor中有大量的估计用不到的字段（光user就有191个字段，头秃），且有储存额外信息的需求（最关键的是这个主键有点离谱），可能会准备设计一些额外的表，使用外键关联到casdoor的user表。

计划所有额外的表都使用casdoor user的name字段来作为外键。这个name储存学号，登陆的时候使用学号+密码的形式登陆。

==注意：除了在casdoor中的表，其他的所有地方，用户id指学号，name指真实姓名。==

#### 用户详情表

计划建立一个用户详情表，和casdoor的user表一一对应。然后建立一个视图，形成一个完整的用户信息。

额外的表中使用id（学号）来作为主键。目前暂时没有需要填写的信息。





## 二、邮件

目前打算使用MongoDB。

当发起一个邮件后，可以检索对应的列表，找到所有属于这个邮件发送的对象，为其的邮件箱的未读添加一个引用，指向自己。

==设计原则，邮件不能引用用户，只能记录信息，用户可以引用邮件，避免循环引用。==

### 邮件中心

根据的内容，邮件分为通知邮件和任务邮件，任务邮件还会具体划分任务类型。通知邮件只有信息，任务邮件还会附带一个任务。

根据发布者可以分为系统提示和成员发布。

#### 1.邮件分类

邮件内容具体分为以下几类：

| 邮件分类 | 附带任务           | 具体描述                               |
| -------- | ------------------ | -------------------------------------- |
| 通知邮件 | 没有               | 一段文字                               |
| 选择邮件 | 附带选项           | 发布者添加几个选项，供接受邮件的人选择 |
| 判断邮件 | 附带是否选项       | 特殊的选择邮件                         |
| 附件邮件 | 附带文件           | 附带可供下载的文件                     |
| 收集邮件 | 附带上传文件的功能 |                                        |

~~邮件的发布者可以是用户可以是成员。邮件应该有收集结果的功能，将任务处理的进度等收集，只有发布者可查看进度。对于系统发给的用户个人的通知处理邮件无需收集结果，而对于系统群发的任务邮件，进度是给管理员查看的。~~

~~成员可以向其他的成员发布邮件，可以收集到任务的结果。这个任务可以添加到任务管理界面，时时查看进度。~~

系统可以发布群通知，也可以给对应的人发布邮件来让其处理事物。

只有系统才可以发任务邮件，用户只能发布通知邮件和附件邮件。

#### 2.集合的设计

根据以上需求，设计两个集合，system_mail_center，member_mail_center。分别储存系统邮件和成员邮件。

他们的区别就是将所有的系统邮件没有进度，且系统邮件发件人全部是系统提示。

#### 3.具体邮件文档的设计

##### 3.3通知邮件

这也是最基础的邮件，其他邮件全部继承于此。

包含以下字段：

| 字段名    | 数据类型 | 注释                         |
| --------- | -------- | ---------------------------- |
| id        | int      | 每一个邮件独有的id           |
| title     | text     | 邮件的主题                   |
| sender    | text     | 邮件发布者的名字             |
| sender_id | int      | 邮件发布者的id               |
| pubdate   | date     | 发布时间                     |
| body      | text     | 主体内容                     |
| receiver  | array    | 接受邮件的成员的id组成的数组 |

还有一个type字段，邮件的类型



##### 3.4选择邮件

除了以上的字段，还有以下字段。

| 字段名             | 数据类型 | 注释         |
| ------------------ | -------- | ------------ |
| is_multiple_choice | bool     | 是否可以多选 |
| options            | array    | 所有的选项   |
| results            | document | 选择结果     |

result的字段为options中的每一个选项+‘_Null’，这个字段代表还没有作出选择。这每一个字段的类型为用户的id组成的数组。

以json作为示例：

```json
{
    "result":{
        "完成":[用户id],
        "未完成":[用户id],
        "完成部分":[用户id],
        "_Null":[用户id],
    }   
}
```

##### 3.5判断邮件

和选择邮件一样，只不过将选项自动设置。

##### 3.6附件邮件

在通知邮件的基础上，增加attachment字段。数据类型为文档。

| 字段 | 数据类型 | 注释          |
| ---- | -------- | ------------- |
| name | text     | 附件名        |
| size | int      | kb数          |
| url  | text     | 下载附件的url |

##### 3.7收集邮件

新增以下字段：

| 字段             | 数据类型 | 注释                                       |
| ---------------- | -------- | ------------------------------------------ |
| file_type        | array    | 包含想要的文档类型，数组为空代表所有的类型 |
| storage_location | test     | 想要储存文档的位置                         |
| size_limit       | int      | 大小限制，kb数，为0代表无限制              |
| collect_results  | array    | 上传结果                                   |

collect_results中为每一个人建立一个文档，这个文档中的字段：

| 字段      | 数据类型 | 注释       |
| --------- | -------- | ---------- |
| id        | int      | 成员id     |
| name      | text     | 成员名字   |
| is_upload | bool     | 是否上传   |
| size      | int      | 文件的大小 |



==注意附件邮件和收集邮件需要结合文件系统来使用，目前只是暂定，要等文件系统设计出来后具体结合。==





### 用户邮件箱

创建集合user_mail_box。为方便查询，为id字段设置索引。

为每一个用户创建一个文档，用来储存其应该收到的邮件，储存形式为引用邮件中心的邮件。

同时这个文档还储存一些额外信息。具体信息参考以下：

| 字段           | 数据类型 | 注释                                   |
| -------------- | -------- | -------------------------------------- |
| id             | int      | 用户id                                 |
| name           | text     | 用户名字                               |
| sendable_group | array    | 可以发送的群组                         |
| sendable_user  | array    | 除了可以发送的群组以外的额外成员的引用 |
| mailbox        | document | 收件箱                                 |
| send_history   | array    | 自己发送的所有的邮件的引用             |
|                |          |                                        |

mailbox中的字段为两个array：

+ 已完成
+ 未完成

array中包含的为document，每一个document都记录着一个邮件的信息。

这个document的字段：

| 字段        | 数据类型                   | 注释                           |
| ----------- | -------------------------- | ------------------------------ |
| mail        | 引用                       | 邮件的引用                     |
| deal_record | 不同类型的邮件对应的不一样 | 记录用户自己对这个邮件处理记录 |





## 三、职务

储存在mysql中。

模仿RBAC，设置不同的职务，每个**职务**有不同的**责任**。将所有的责任记录为一张表，然后将所有的职务记录为一张表。然后每一个人都有一个职务。

**在用户表中增加一条职务的外键**

设置一个职务表

设置一个责任表

设置一个责任职务映射表

用户与职务为一对多的关系，职务与责任为多对多的关系。



职务表：

| 字段名      | 数据类型 | 注释               |
| ----------- | -------- | ------------------ |
| name        | text(30) | 职务的名字（唯一） |
| displayname | text(30) | 显示的名字         |
| describe    | text     | 职务的描述         |





责任表：

| 字段名 | 数据类型 | 注释             |
| ------ | -------- | ---------------- |
| name   | text(30) | 唯一，权限的名字 |



职务责任映射表：

| 字段名        | 数据类型 | 注释             |
| ------------- | -------- | ---------------- |
| id            | int      |                  |
| position_name | text(30) | 职务的名字，外键 |
| duty_name     | text(30) | 权限的名字，外键 |



## 四、服务

储存在mysql中。

### 1.申请

#### 1.1概览

有多种类型的申请，每一种申请都对应着一种事件。

+ 申请人
+ 申请日期
+ 处理结果
+ 处理人
+ 处理日期
+ 申请的文件
+ 是否完成

这些是都要记录的信息，其中不同类型的申请的处理结果不同。因此不同的申请只有处理结果这一项信息不同。

以下是具体的除了申请结果的字段：

| 字段名           | 数据类型 | 注释       |
| ---------------- | -------- | ---------- |
| id               | int      | 申请的id   |
| applicant_id     | int      | 申请人id   |
| applicant_name   | text     | 申请人名字 |
| application_date | datetime | 申请日期   |
| handler_id       | int      | 处理人id   |
| handler_name     | text     | 处理人名字 |
| handler_date     | datetime | 处理日期   |
| is_finished      | bool     | 是否完成   |
| file             | int      | 文件       |

这是所有的申请都需要包含的，以下是所有各个类型的申请的申请结果字段

#### 1.2 科研助手申请

#### 1.3 报销申请

### 2.任务













